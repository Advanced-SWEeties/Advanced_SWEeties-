name: Spring Boot CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Style check
      run: mvn checkstyle:check

    - name: Build with Maven
      run: mvn clean install

    - name: Run tests
      run: mvn test
  deploy:
    runs-on: ubuntu-latest
    needs: build  

    steps:
    - uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'temurin'

    # Set up Google Cloud SDK
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}

    # Authenticate to Google Cloud using the service account
    - name: Authenticate to GCP
      run: |
        echo "${{ secrets.GCP_SA_KEY }}" > "${HOME}/gcloud-service-key.json"
        gcloud auth activate-service-account --key-file="${HOME}/gcloud-service-key.json"

    # Set the active project
    - name: Set GCP Project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    # Deploy to Google App Engine
    - name: Deploy to Google App Engine
      run: gcloud app deploy app.yaml --quiet
